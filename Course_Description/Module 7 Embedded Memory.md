# FPGA 系統設計中的嵌入式記憶體概覽

## Xilinx 中整合嵌入式記憶體的三種方法

1. **HDL 實例化 (HDL instantiation)**：
   - 在 Vivado Project Navigator 中用於推斷 Block RAM。

2. **Core Generator 程式**：
   - 使用 Xilinx 提供的圖形化工具產生記憶體模組。

3. **行為 HDL 推斷模板 (Behavioral HDL inference template)**：
   - 用於 Xilinx Synthesis Tool (XST)。

> 可在 Vivado 的「Language Templates」中找到 HDL 實例化程式碼，例如 Artix-7 的 18Kb Block RAM Memory (RAMB18E1)。

```Verilog
// RAMB18E1: 18K-bit Configurable Synchronous Block RAM
    //           Artix-7
    // Xilinx HDL Language Template, version 2023.2
 
    RAMB18E1 #(
       .RDADDR_COLLISION_HWCONFIG("DELAYED_WRITE"),
       .SIM_COLLISION_CHECK("ALL"),
       .DOA_REG(0),
       .DOB_REG(0),
       .INITP_00(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INITP_01(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INITP_02(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INITP_03(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INITP_04(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INITP_05(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INITP_06(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INITP_07(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_00(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_01(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_02(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_03(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_04(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_05(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_06(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_07(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_08(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_09(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_0A(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_0B(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_0C(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_0D(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_0E(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_0F(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_10(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_11(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_12(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_13(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_14(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_15(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_16(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_17(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_18(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_19(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_1A(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_1B(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_1C(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_1D(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_1E(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_1F(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_20(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_21(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_22(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_23(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_24(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_25(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_26(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_27(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_28(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_29(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_2A(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_2B(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_2C(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_2D(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_2E(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_2F(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_30(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_31(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_32(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_33(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_34(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_35(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_36(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_37(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_38(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_39(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_3A(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_3B(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_3C(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_3D(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_3E(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_3F(256'h0000000000000000000000000000000000000000000000000000000000000000),
       .INIT_A(18'h00000),
       .INIT_B(18'h00000),
       .INIT_FILE("NONE"),
       .RAM_MODE("TDP"),
       .READ_WIDTH_A(RWWIDTH),        
       .READ_WIDTH_B(0),                        
       .WRITE_WIDTH_A(0),                               
       .WRITE_WIDTH_B(RWWIDTH),
       .RSTREG_PRIORITY_A("RSTREG"),
       .RSTREG_PRIORITY_B("RSTREG"),
       .SRVAL_A(18'h00000),
       .SRVAL_B(18'h00000),
       .SIM_DEVICE("7SERIES"),
       .WRITE_MODE_A("WRITE_FIRST"),
       .WRITE_MODE_B("WRITE_FIRST")
    )
    RAMB18E1_inst (
       .DOADO(r_data16),           
       .DOPADOP(),            
       .DOBDO(),             
       .DOPBDOP(),             
       .ADDRARDADDR(address_read),     
       .CLKARDCLK(clk),         
       .ENARDEN(rd_en),            
       .REGCEAREGCE(),     
       .RSTRAMARSTRAM(reset), 
       .RSTREGARSTREG(), 
       .WEA(),                   
       .DIADI(),               
       .DIPADIP(),             
       .ADDRBWRADDR(address_write),     
       .CLKBWRCLK(clk),       
       .ENBWREN(wr_en),        
       .REGCEB(),               
       .RSTRAMB(reset),             
       .RSTREGB(),             
       .WEBWE({wr, wr, wr, wr}),               
       .DIBDI(w_data),                
       .DIPBDIP()              
    );

   // assign address
	assign address_read = {{(14-E-W){1'b0}}, (w_ptr_reg == 0 ? {W{1'b1}} : w_ptr_reg - 1), {E{1'b0}}};
	assign address_write = {{(14-E-W){1'b0}}, w_ptr_reg, {E{1'b0}}}; 

```
address_read 用於 .ADDRARDADDR(address_read), **透過設計地址，我們只需要專注指針設計就好(w_ptr_reg)**，address_write同理

---

## Artix-7 裝置中的嵌入式記憶體類型

### 分散式 RAM (Distributed RAM)
- 由邏輯單元中的查閱表 (LUT) 建構而成。
- 在 XC7A35T 裝置中，最大容量約為 400Kb。

### 塊狀 RAM (Block RAM)
- 嵌入在 FPGA 裝置中的特殊記憶體模組，與邏輯單元分離。
- 在 XC7A35T 裝置中：
  - 每個 Block 的容量為 36Kb。
  - 總共有 50 個 Block。

分散式 RAM 和塊狀 RAM 都有同步介面，不需額外控制電路。

---

## 設計範例：基於 Block-RAM 的 FIFO

### FIFO (First-In-First-Out) 緩衝區
- 也稱為佇列 (queue)。
- 使用 18K 位元可配置同步 Block RAM 模組 (RAMB18E1)。

### 特性與實作細節
- **參數化設計**：位元數、讀寫寬度、位址位元數等。
- **讀寫控制邏輯**：
  - 寫入僅在 FIFO 未滿時啟用。
  - 讀取僅在 FIFO 未空時啟用。
- **指標管理**：
  - `w_ptr_reg`：寫入指標。
  - `r_ptr_reg`：讀取指標。
  - `full_reg` / `empty_reg`：狀態旗標。
- **測試模組 fifo_test**：
  - 使用按鈕控制讀寫。
  - 使用開關輸入資料。
  - 使用 LED 顯示讀取資料與滿/空狀態。

---

## ROM (唯讀記憶體)

### 實現方式
- 使用組合邏輯電路（combinational circuit）。
- 或使用單埠 RAM，並禁用寫入操作。

### 讀取類型
- **非同步**（asynchronous）或 **同步**（synchronous）讀取。

📌 提供非同步與同步讀取 ROM 的 Verilog 模板。

---

## 設計範例：基於 ROM 的 sin(x) 函數

- **應用**：利用 ROM 儲存 sin(x) 取樣值。
- **輸入解析度**：6 位元，對應 0~2π 之間的 64 個點。
  - 例：000000 = 0，010000 = π/2。
- **輸出解析度**：5 位元，代表 -1 到 1 間的 32 個點。
  - 例：00000 = 0，01111 = 1，10001 = -1。
- **設計方式**：同步讀取 ROM。
- **測試平台**：
  - 顯示三個完整週期的正弦波。
  - 可於模擬器中觀察波形與符號化十進位輸出。

---
